@attribute [Route(AppStrings.Pages.Home)]
@inject IThemeService themeService
@inject SessionStorageService sessionStorageService
@inject AuthenticationService authenticationService
@inject GameManagerService gameManager
@implements IAsyncDisposable

<PageTitle>Aneejian | Click and Match</PageTitle>

@if (!authenticationService.IsAuthenticated || ShowProfiles)
{
	<_UserProfiles OnUserSelected="OnUserSelected" />
	<div class="text-center">
		<_Disclaimer />
	</div>
}

<_AuthorizedOnly>
	<CascadingValue Value="LoggedInUser" Name="LoggedInUser" IsFixed=true>
		<_Game />
	</CascadingValue>
</_AuthorizedOnly>

@code {
	private UserDto? LoggedInUser { get; set; }

	private bool ShowProfiles { get; set; } = true;

	private IThemeService ThemeService => themeService;

	protected override void OnInitialized()
	{
		CheckLogin();
		ShowProfiles = !authenticationService.IsAuthenticated;
		authenticationService.OnAuthenticationStateChanged += CheckLogin;
		base.OnInitialized();
	}

	private void CheckLogin(bool isAuthenticated)
	{
		if (!authenticationService.IsAuthenticated)
		{
			StateHasChanged();
			try { gameManager.ResetGame(); }
			catch { }
			ShowProfiles = true;
			LoggedInUser = null;
			return;
		}
		CheckLogin();
	}

	private void OnUserSelected(UserDto user)
	{
		LoggedInUser = user;
		ShowProfiles = false;
		StateHasChanged();
	}

	private void CheckLogin()
	{
		var autheticatedUser = authenticationService.AuthenticatedUser;
		LoggedInUser = autheticatedUser;
		StateHasChanged();
	}

	public async ValueTask DisposeAsync()
	{
		if (authenticationService != null)
		{
			await authenticationService.Logout();
			authenticationService.OnAuthenticationStateChanged -= CheckLogin;
		}
	}

}